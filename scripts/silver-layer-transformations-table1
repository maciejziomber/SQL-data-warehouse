-- This code shows transforamtions from bronze to silver layer for crm_cust_info table

SELECT * FROM bronze.crm_cust_info
SELECT * FROM bronze.crm_prd_info
SELECT * FROM bronze.crm_sales_details
SELECT * FROM bronze.erp_cust_az12
SELECT * FROM bronze.erp_loc_a101
SELECT * FROM bronze.erp_px_cat_g1v2 

-- Check For duplicate Primary Keys
SELECT
cst_id, -- Primary Key
COUNT(*)
FROM bronze.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1

-- Flag data (Displays data with no Primary Key duplicates) (In case of duplicate, it chooses the record with the latest create date)
SELECT
* 
FROM (
SELECT *,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_Date DESC) AS flag_last
FROM bronze.crm_cust_info
)t 
WHERE flag_last = 1

-- Check for unwanted spaces
-- Expectation: no results
SELECT 
cst_firstname
FROM bronze.crm_cust_info
WHERE cst_firstname != TRIM(cst_firstname)

SELECT
cst_id,
cst_key,
TRIM(cst_firstname) AS cst_firstname,
TRIM(cst_lastname) AS cst_lastname,
cst_material_status,
cst_gndr,
cst_create_Date
FROM (
    SELECT *,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_Date DESC) AS flag_last
FROM bronze.crm_cust_info
)t 
WHERE flag_last = 1

-- Standardization and naming convention 

SELECT DISTINCT cst_gndr
FROM bronze.crm_cust_info

SELECT
cst_id,
cst_key,
TRIM(cst_firstname) AS cst_firstname,
TRIM(cst_lastname) AS cst_lastname,
cst_material_status,
CASE WHEN UPPER(cst_gndr) = 'F' THEN 'Female'
    WHEN UPPER(cst_gndr) = 'M' THEN 'Male'
    ELSE 'n/a'
END AS cst_gndr,
cst_create_Date
FROM (
    SELECT *,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_Date DESC) AS flag_last
FROM bronze.crm_cust_info
)t 
WHERE flag_last = 1

SELECT DISTINCT cst_material_status
FROM bronze.crm_cust_info

SELECT
cst_id,
cst_key,
TRIM(cst_firstname) AS cst_firstname,
TRIM(cst_lastname) AS cst_lastname,
CASE WHEN UPPER(cst_material_status) = 'S' THEN 'Single'
    WHEN UPPER(cst_material_status) = 'M' THEN 'Married'
    ELSE 'n/a'
END AS cst_marital_status,
CASE WHEN UPPER(cst_gndr) = 'F' THEN 'Female'
    WHEN UPPER(cst_gndr) = 'M' THEN 'Male'
    ELSE 'n/a'
END AS cst_gndr,
cst_create_Date
FROM (
    SELECT *,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_Date DESC) AS flag_last
FROM bronze.crm_cust_info
)t 
WHERE flag_last = 1

-------------------- FINAL STEP --------------------------
-- Insert into silver layer

INSERT INTO silver.crm_cust_info (
    cst_id,
    cst_key,
    cst_firstname,
    cst_lastname,
    cst_material_status,
    cst_gndr,
    cst_create_Date
)

SELECT
cst_id,
cst_key,
TRIM(cst_firstname) AS cst_firstname,
TRIM(cst_lastname) AS cst_lastname,
CASE WHEN UPPER(cst_material_status) = 'S' THEN 'Single'
    WHEN UPPER(cst_material_status) = 'M' THEN 'Married'
    ELSE 'n/a'
END AS cst_marital_Status,
CASE WHEN UPPER(cst_gndr) = 'F' THEN 'Female'
    WHEN UPPER(cst_gndr) = 'M' THEN 'Male'
    ELSE 'n/a'
END AS cst_gndr,
cst_create_Date
FROM (
    SELECT *,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_Date DESC) AS flag_last
FROM bronze.crm_cust_info
)t 
WHERE flag_last = 1

-- Now perform a quaility check for silver layer that was just created using same queries as before:

-- Check For duplicate Primary Keys
SELECT
cst_id, -- Primary Key
COUNT(*)
FROM silver.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1

-- empty spaces
SELECT 
cst_firstname
FROM silver.crm_cust_info
WHERE cst_firstname != TRIM(cst_firstname)

-- Standarization
SELECT DISTINCT cst_gndr
FROM silver.crm_cust_info

-- Take a look at the whole table
 
